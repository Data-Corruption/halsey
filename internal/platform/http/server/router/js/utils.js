(()=>{var L="nord",v="night",T="HALSEY_THEME";function B(){return localStorage.getItem(T)||(window.matchMedia?.("(prefers-color-scheme: dark)").matches?v:L)}function M(){return B()===v}function N(){let e=document.getElementById("theme-toggle");e&&(e.checked=M())}function G(e){localStorage.setItem(T,e),document.documentElement.setAttribute("data-theme",e),N()}function A(){G(M()?L:v)}function $(){let e=B();document.documentElement.setAttribute("data-theme",e),localStorage.setItem(T,e)}function D(){N()}function k(){let e=document.getElementById("click-blocker");e&&e.classList.remove("hidden")}function m(){let e=document.getElementById("click-blocker");e&&e.classList.add("hidden")}function g(e){e&&(e.className="status loading loading-spinner loading-xs",e.textContent="",e.dataset.errorMessage="",e.onclick=null)}function h(e){e&&(e.className="status status-success",e.dataset.errorMessage="",e.onclick=null,setTimeout(()=>{e.classList.contains("status-success")&&(e.className="status hidden")},2e3))}function p(e,t){e&&(e.className="status status-error cursor-pointer",e.dataset.errorMessage=t||"An unknown error occurred.",e.onclick=()=>{let n=document.getElementById("error-modal"),o=document.getElementById("error-modal-message");n&&o&&(o.textContent=e.dataset.errorMessage,n.showModal())})}function b(e){let t=e.closest("label");if(t){let r=t.querySelector(".status");if(r)return r}let n=e.closest(".flex");if(n){let r=n.querySelector(".status");if(r)return r}let o=e.closest(".form-control");return o?o.querySelector(".status"):null}function R(){let e=document.getElementById("backups-modal"),t=document.getElementById("backups-loading"),n=document.getElementById("backups-content"),o=document.getElementById("backups-empty"),r=document.getElementById("backups-error"),s=document.getElementById("backups-error-message");t.classList.remove("hidden"),n.classList.add("hidden"),o.classList.add("hidden"),r.classList.add("hidden"),n.innerHTML="",e.showModal(),fetch("/settings/backups").then(a=>{if(!a.ok)throw new Error(`HTTP ${a.status}`);return a.json()}).then(a=>{if(t.classList.add("hidden"),!a||a.length===0){o.classList.remove("hidden");return}a.forEach(c=>{let i=document.createElement("div");i.className="flex items-center justify-between bg-base-200/50 rounded-lg p-3";let d=document.createElement("div");d.className="flex-1";let S=document.createElement("div");S.className="font-medium text-base-content",S.textContent=c.guildName;let x=document.createElement("div");if(x.className="text-xs text-base-content/50",c.lastRun){let C=new Date(c.lastRun);x.textContent="Last backup: "+C.toLocaleDateString()+" "+C.toLocaleTimeString()}else x.textContent="No backup run yet";d.appendChild(S),d.appendChild(x);let E=document.createElement("a");c.lastRun?(E.className="btn btn-sm btn-primary",E.href=c.downloadLink):E.className="btn btn-sm btn-primary btn-disabled",E.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                `,i.appendChild(d),i.appendChild(E),n.appendChild(i)}),n.classList.remove("hidden")}).catch(a=>{t.classList.add("hidden"),r.classList.remove("hidden"),s.textContent=a.message||"Failed to load backups."})}function P(){confirm("Are you sure you want to stop the server? You will lose access to this page.")&&(k(),fetch("/settings/stop",{method:"POST"}).then(e=>{if(e.ok)alert("Server is shutting down...");else throw new Error("Failed to stop server")}).catch(e=>{m(),alert("Error: "+e.message)}))}function q(){let e=document.getElementById("restart-register-commands").checked,t=document.getElementById("restart-update").checked;document.getElementById("restart-modal").close(),k(),fetch("/settings/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({register_commands:e,update:t})}).then(n=>{if(n.ok||n.status===202)setTimeout(()=>F(t),3e3);else throw new Error("Failed to restart server")}).catch(n=>{m(),alert("Error: "+n.message)})}function F(e=!1){let t=Date.now(),n=3e3,o=3e5,r=()=>{if(Date.now()-t>o){m(),alert("Restart timed out. Please check logs or try again.");return}console.log("Polling for restart...",{updateRequested:e,time:Date.now()-t}),fetch("/settings/restart-status?t="+Date.now()).then(s=>s.json()).then(s=>{console.log("Poll response:",s),s.restarted?e&&!s.updated?(console.warn("Restart detected but not updated.",s),m(),alert("Restart completed, but the update did not apply. You may already be on the latest version, or the update failed.")):(console.log("Restart success (updated="+s.updated+"), reloading..."),window.location.reload()):setTimeout(r,n)}).catch(s=>{console.error("Poll network error (expected if restarting):",s),setTimeout(r,n)})};r()}async function f(e,t,n){let o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n});if(!o.ok){let r=await o.text();throw new Error(r||`HTTP ${o.status}`)}return o}async function H(e){let t=await fetch(e,{method:"DELETE"});if(!t.ok){let n=await t.text();throw new Error(n||`HTTP ${t.status}`)}return t}function l(e,t,n){let o=typeof e=="string"?document.getElementById(e):e;if(!o)return;let r=b(o);o.addEventListener("change",async()=>{g(r);try{let s={},a=n.split(".");a.length===2?s[a[0]]={[a[1]]:o.checked}:s[n]=o.checked,await f(t,s),h(r)}catch(s){p(r,s.message)}})}function O(e,t,n,o){let r=typeof e=="string"?document.getElementById(e):e;if(!r)return;let s=b(r);r.addEventListener("change",async()=>{g(s);try{await f(t,{[n]:r.value}),h(s),o&&o()}catch(a){p(s,a.message)}})}function u(e,t,n,o=500,r={}){let s=typeof e=="string"?document.getElementById(e):e;if(!s)return;let a=b(s),c=null,i=null;s.addEventListener("input",()=>{clearTimeout(c),i&&i.abort(),c=setTimeout(async()=>{if(!(r.skipEmpty&&!s.value.trim())){i=new AbortController,g(a);try{let d=s.value;if(s.type==="number"&&(d=parseInt(d,10),isNaN(d)))throw new Error("Invalid number");await f(t,{[n]:d},i.signal),h(a),r.onSuccess&&r.onSuccess()}catch(d){d.name!=="AbortError"&&p(a,d.message)}}},o)})}function w(e,t,n){let o=b(e);e.addEventListener("change",async()=>{g(o);try{await f(t,n(e.checked)),h(o)}catch(r){p(o,r.message)}})}function I(e,t,n){e.addEventListener("change",async()=>{try{await f(t(e),n(e.value))}catch(o){console.error("Failed to update:",o)}})}function y(){let e=document.getElementById("restart-required-notice");e&&e.classList.remove("hidden")}function J(){l("backup-opt-out","/settings/user","backupOptOut"),l("ai-chat-opt-out","/settings/user","aiChatOptOut"),l("auto-expand-reddit","/settings/user","autoExpand.reddit"),l("auto-expand-youtube-shorts","/settings/user","autoExpand.youTubeShorts"),l("auto-expand-redgifs","/settings/user","autoExpand.redGifs")}function _(){O("admin-log-level","/settings/admin","logLevel",y),u("admin-host","/settings/admin","host",500,{onSuccess:y}),u("admin-port","/settings/admin","port",500,{onSuccess:y}),u("admin-proxy-port","/settings/admin","proxyPort",500,{onSuccess:y}),u("admin-bot-token","/settings/admin","botToken",500,{skipEmpty:!0,onSuccess:y}),u("admin-ollama-url","/settings/admin","ollamaURL",500,{onSuccess:y});let e=document.getElementById("admin-update-yt-dlp");if(e){let t=e.parentElement.querySelector(".status");e.addEventListener("click",async()=>{e.disabled=!0,g(t);try{let n=await fetch("/settings/update-yt-dlp",{method:"GET"});if(!n.ok){let o=await n.text();throw new Error(o||`HTTP ${n.status}`)}h(t)}catch(n){p(t,n.message)}finally{e.disabled=!1}})}}function U(){document.querySelectorAll(".collapse[data-guild-id]").forEach(e=>{let t=e.dataset.guildId;if(!t)return;let n=`/settings/guild/${t}`;u(`guild-${t}-backup-password`,n,"backupPassword",500,{skipEmpty:!0}),u(`guild-${t}-synctube`,n,"synctubeURL",500),l(`guild-${t}-backup`,n,"backupEnabled"),l(`guild-${t}-antirot`,n,"antiRotEnabled"),l(`guild-${t}-aichat`,n,"aiChatEnabled")})}function Y(){document.querySelectorAll(".channel-backup").forEach(e=>{let t=e.dataset.channelId;t&&w(e,`/settings/channel/${t}`,n=>({backupEnabled:n}))}),document.querySelectorAll(".channel-aichat").forEach(e=>{let t=e.dataset.channelId;t&&w(e,`/settings/channel/${t}`,n=>({aiChat:n}))}),document.querySelectorAll(".guild-fav-channel").forEach(e=>{I(e,t=>`/settings/guild/${t.dataset.guildId}`,t=>({favChannelID:t}))}),document.querySelectorAll(".guild-bot-channel").forEach(e=>{I(e,t=>`/settings/guild/${t.dataset.guildId}`,t=>({botChannelID:t}))})}function K(){let e=document.getElementById("delete-guild-modal"),t=document.getElementById("delete-guild-name"),n=document.getElementById("delete-guild-confirm-input"),o=document.getElementById("delete-guild-confirm-btn"),r=document.getElementById("delete-guild-id");!e||!o||(document.querySelectorAll(".delete-guild-btn").forEach(s=>{s.addEventListener("click",()=>{let a=s.dataset.guildId,c=s.dataset.guildName;t.textContent=c,r.value=a,n.value="",o.disabled=!0,e.showModal()})}),n.addEventListener("input",()=>{let s=t.textContent;o.disabled=n.value!==s}),o.addEventListener("click",async()=>{let s=r.value;if(s){o.disabled=!0,o.innerHTML='<span class="loading loading-spinner loading-sm"></span> Deleting...';try{await H(`/settings/guild/${s}`),e.close(),window.location.reload()}catch(a){o.disabled=!1,o.textContent="Delete Guild";let c=document.getElementById("error-modal"),i=document.getElementById("error-modal-message");c&&i&&(i.textContent=a.message||"Failed to delete guild.",c.showModal())}}}),e.addEventListener("close",()=>{n.value="",o.disabled=!0,o.textContent="Delete Guild"}))}function V(){document.querySelectorAll(".user-admin").forEach(e=>{let t=e.dataset.userId;t&&w(e,`/settings/user/${t}`,n=>({isAdmin:n}))}),document.querySelectorAll(".user-backup").forEach(e=>{let t=e.dataset.userId;t&&w(e,`/settings/user/${t}`,n=>({backupAccess:n}))}),document.querySelectorAll(".user-ai").forEach(e=>{let t=e.dataset.userId;t&&w(e,`/settings/user/${t}`,n=>({aiAccess:n}))})}function j(){J(),_(),U(),Y(),K(),V()}$();window.toggleTheme=A;window.openBackupsModal=R;window.stopServer=P;window.restartServer=q;window.blockClicks=k;window.unblockClicks=m;document.addEventListener("DOMContentLoaded",()=>{D(),j()});})();
