(()=>{var L="nord",T="night",v="HALSEY_THEME";function B(){return localStorage.getItem(v)||(window.matchMedia?.("(prefers-color-scheme: dark)").matches?T:L)}function M(){return B()===T}function A(){let e=document.getElementById("theme-toggle");e&&(e.checked=M())}function j(e){localStorage.setItem(v,e),document.documentElement.setAttribute("data-theme",e),A()}function N(){j(M()?L:T)}function $(){let e=B();document.documentElement.setAttribute("data-theme",e),localStorage.setItem(v,e)}function D(){A()}function b(){let e=document.getElementById("click-blocker");e&&e.classList.remove("hidden")}function m(){let e=document.getElementById("click-blocker");e&&e.classList.add("hidden")}function g(e){e&&(e.className="status loading loading-spinner loading-xs",e.textContent="",e.dataset.errorMessage="",e.onclick=null)}function p(e){e&&(e.className="status status-success",e.dataset.errorMessage="",e.onclick=null,setTimeout(()=>{e.classList.contains("status-success")&&(e.className="status hidden")},2e3))}function h(e,t){e&&(e.className="status status-error cursor-pointer",e.dataset.errorMessage=t||"An unknown error occurred.",e.onclick=()=>{let n=document.getElementById("error-modal"),o=document.getElementById("error-modal-message");n&&o&&(o.textContent=e.dataset.errorMessage,n.showModal())})}function k(e){let t=e.closest("label");if(t){let a=t.querySelector(".status");if(a)return a}let n=e.closest(".flex");if(n){let a=n.querySelector(".status");if(a)return a}let o=e.closest(".form-control");return o?o.querySelector(".status"):null}function R(){let e=document.getElementById("backups-modal"),t=document.getElementById("backups-loading"),n=document.getElementById("backups-content"),o=document.getElementById("backups-empty"),a=document.getElementById("backups-error"),s=document.getElementById("backups-error-message");t.classList.remove("hidden"),n.classList.add("hidden"),o.classList.add("hidden"),a.classList.add("hidden"),n.innerHTML="",e.showModal(),fetch("/settings/backups").then(r=>{if(!r.ok)throw new Error(`HTTP ${r.status}`);return r.json()}).then(r=>{if(t.classList.add("hidden"),!r||r.length===0){o.classList.remove("hidden");return}r.forEach(d=>{let i=document.createElement("div");i.className="flex items-center justify-between bg-base-200/50 rounded-lg p-3";let c=document.createElement("div");c.className="flex-1";let S=document.createElement("div");S.className="font-medium text-base-content",S.textContent=d.guildName;let x=document.createElement("div");if(x.className="text-xs text-base-content/50",d.lastRun){let C=new Date(d.lastRun);x.textContent="Last backup: "+C.toLocaleDateString()+" "+C.toLocaleTimeString()}else x.textContent="No backup run yet";c.appendChild(S),c.appendChild(x);let E=document.createElement("a");d.lastRun?(E.className="btn btn-sm btn-primary",E.href=d.downloadLink):E.className="btn btn-sm btn-primary btn-disabled",E.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download
                `,i.appendChild(c),i.appendChild(E),n.appendChild(i)}),n.classList.remove("hidden")}).catch(r=>{t.classList.add("hidden"),a.classList.remove("hidden"),s.textContent=r.message||"Failed to load backups."})}function P(){confirm("Are you sure you want to stop the server? You will lose access to this page.")&&(b(),fetch("/settings/stop",{method:"POST"}).then(e=>{if(e.ok)alert("Server is shutting down...");else throw new Error("Failed to stop server")}).catch(e=>{m(),alert("Error: "+e.message)}))}function q(){let e=document.getElementById("restart-register-commands").checked,t=document.getElementById("restart-update").checked;document.getElementById("restart-modal").close(),b(),fetch("/settings/restart",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({register_commands:e,update:t})}).then(n=>{if(n.ok||n.status===202)setTimeout(()=>F(t),3e3);else throw new Error("Failed to restart server")}).catch(n=>{m(),alert("Error: "+n.message)})}function F(e=!1){let t=Date.now(),n=3e3,o=3e5,a=()=>{if(Date.now()-t>o){m(),alert("Restart timed out. Please check logs or try again.");return}console.log("Polling for restart...",{updateRequested:e,time:Date.now()-t}),fetch("/settings/restart-status?t="+Date.now()).then(s=>s.json()).then(s=>{console.log("Poll response:",s),s.restarted?e&&!s.updated?(console.warn("Restart detected but not updated.",s),m(),alert("Restart completed, but the update did not apply. You may already be on the latest version, or the update failed.")):(console.log("Restart success (updated="+s.updated+"), reloading..."),window.location.reload()):setTimeout(a,n)}).catch(s=>{console.error("Poll network error (expected if restarting):",s),setTimeout(a,n)})};a()}async function f(e,t,n){let o=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:n});if(!o.ok){let a=await o.text();throw new Error(a||`HTTP ${o.status}`)}return o}async function H(e){let t=await fetch(e,{method:"DELETE"});if(!t.ok){let n=await t.text();throw new Error(n||`HTTP ${t.status}`)}return t}function l(e,t,n){let o=typeof e=="string"?document.getElementById(e):e;if(!o)return;let a=k(o);o.addEventListener("change",async()=>{g(a);try{let s={},r=n.split(".");r.length===2?s[r[0]]={[r[1]]:o.checked}:s[n]=o.checked,await f(t,s),p(a)}catch(s){h(a,s.message)}})}function G(e,t,n,o){let a=typeof e=="string"?document.getElementById(e):e;if(!a)return;let s=k(a);a.addEventListener("change",async()=>{g(s);try{await f(t,{[n]:a.value}),p(s),o&&o()}catch(r){h(s,r.message)}})}function u(e,t,n,o=500,a={}){let s=typeof e=="string"?document.getElementById(e):e;if(!s)return;let r=k(s),d=null,i=null;s.addEventListener("input",()=>{clearTimeout(d),i&&i.abort(),d=setTimeout(async()=>{if(!(a.skipEmpty&&!s.value.trim())){i=new AbortController,g(r);try{let c=s.value;if(s.type==="number"&&(c=parseInt(c,10),isNaN(c)))throw new Error("Invalid number");await f(t,{[n]:c},i.signal),p(r),a.onSuccess&&a.onSuccess()}catch(c){c.name!=="AbortError"&&h(r,c.message)}}},o)})}function y(e,t,n){let o=k(e);e.addEventListener("change",async()=>{g(o);try{await f(t,n(e.checked)),p(o)}catch(a){h(o,a.message)}})}function I(e,t,n){e.addEventListener("change",async()=>{try{await f(t(e),n(e.value))}catch(o){console.error("Failed to update:",o)}})}function w(){let e=document.getElementById("restart-required-notice");e&&e.classList.remove("hidden")}function J(){l("backup-opt-out","/settings/user","backupOptOut"),l("ai-chat-opt-out","/settings/user","aiChatOptOut"),l("auto-expand-reddit","/settings/user","autoExpand.reddit"),l("auto-expand-youtube-shorts","/settings/user","autoExpand.youTubeShorts"),l("auto-expand-redgifs","/settings/user","autoExpand.redGifs")}function _(){G("admin-log-level","/settings/admin","logLevel",w),u("admin-host","/settings/admin","host",500,{onSuccess:w}),u("admin-port","/settings/admin","port",500,{onSuccess:w}),u("admin-proxy-port","/settings/admin","proxyPort",500,{onSuccess:w}),u("admin-bot-token","/settings/admin","botToken",500,{skipEmpty:!0,onSuccess:w}),u("admin-ollama-url","/settings/admin","ollamaURL",500,{onSuccess:w}),l("admin-disable-autoexpand-reddit","/settings/admin","disableAutoExpand.reddit"),l("admin-disable-autoexpand-youtube-shorts","/settings/admin","disableAutoExpand.youTubeShorts"),l("admin-disable-autoexpand-redgifs","/settings/admin","disableAutoExpand.redGifs");let e=document.getElementById("admin-update-yt-dlp");if(e){let t=e.parentElement.querySelector(".status");e.addEventListener("click",async()=>{e.disabled=!0,g(t);try{let n=await fetch("/settings/update-yt-dlp",{method:"GET"});if(!n.ok){let o=await n.text();throw new Error(o||`HTTP ${n.status}`)}p(t)}catch(n){h(t,n.message)}finally{e.disabled=!1}})}}function U(){document.querySelectorAll(".collapse[data-guild-id]").forEach(e=>{let t=e.dataset.guildId;if(!t)return;let n=`/settings/guild/${t}`;u(`guild-${t}-backup-password`,n,"backupPassword",500,{skipEmpty:!0}),u(`guild-${t}-synctube`,n,"synctubeURL",500),l(`guild-${t}-backup`,n,"backupEnabled"),l(`guild-${t}-antirot`,n,"antiRotEnabled"),l(`guild-${t}-aichat`,n,"aiChatEnabled")})}function Y(){document.querySelectorAll(".channel-backup").forEach(e=>{let t=e.dataset.channelId;t&&y(e,`/settings/channel/${t}`,n=>({backupEnabled:n}))}),document.querySelectorAll(".channel-aichat").forEach(e=>{let t=e.dataset.channelId;t&&y(e,`/settings/channel/${t}`,n=>({aiChat:n}))}),document.querySelectorAll(".guild-fav-channel").forEach(e=>{I(e,t=>`/settings/guild/${t.dataset.guildId}`,t=>({favChannelID:t}))}),document.querySelectorAll(".guild-bot-channel").forEach(e=>{I(e,t=>`/settings/guild/${t.dataset.guildId}`,t=>({botChannelID:t}))})}function K(){let e=document.getElementById("delete-guild-modal"),t=document.getElementById("delete-guild-name"),n=document.getElementById("delete-guild-confirm-input"),o=document.getElementById("delete-guild-confirm-btn"),a=document.getElementById("delete-guild-id");!e||!o||(document.querySelectorAll(".delete-guild-btn").forEach(s=>{s.addEventListener("click",()=>{let r=s.dataset.guildId,d=s.dataset.guildName;t.textContent=d,a.value=r,n.value="",o.disabled=!0,e.showModal()})}),n.addEventListener("input",()=>{let s=t.textContent;o.disabled=n.value!==s}),o.addEventListener("click",async()=>{let s=a.value;if(s){o.disabled=!0,o.innerHTML='<span class="loading loading-spinner loading-sm"></span> Deleting...';try{await H(`/settings/guild/${s}`),e.close(),window.location.reload()}catch(r){o.disabled=!1,o.textContent="Delete Guild";let d=document.getElementById("error-modal"),i=document.getElementById("error-modal-message");d&&i&&(i.textContent=r.message||"Failed to delete guild.",d.showModal())}}}),e.addEventListener("close",()=>{n.value="",o.disabled=!0,o.textContent="Delete Guild"}))}function V(){document.querySelectorAll(".user-admin").forEach(e=>{let t=e.dataset.userId;t&&y(e,`/settings/user/${t}`,n=>({isAdmin:n}))}),document.querySelectorAll(".user-backup").forEach(e=>{let t=e.dataset.userId;t&&y(e,`/settings/user/${t}`,n=>({backupAccess:n}))}),document.querySelectorAll(".user-ai").forEach(e=>{let t=e.dataset.userId;t&&y(e,`/settings/user/${t}`,n=>({aiAccess:n}))})}function O(){J(),_(),U(),Y(),K(),V()}$();window.toggleTheme=N;window.openBackupsModal=R;window.stopServer=P;window.restartServer=q;window.blockClicks=b;window.unblockClicks=m;document.addEventListener("DOMContentLoaded",()=>{D(),O()});})();
